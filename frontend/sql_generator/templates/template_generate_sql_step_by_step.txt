# STEP-BY-STEP METHOD - Progressive SQL Construction
Generate a SQL query by breaking down the question into logical steps.

## STEP-BY-STEP METHODOLOGY

### Step 1: Understand the Question
- Identify what is being asked (count, list, calculate, etc.)
- Identify the main entities involved
- Identify any conditions or filters

### Step 2: Identify Required Tables
- List all tables needed based on the question
- Verify these tables exist in the schema

### Step 3: Determine Columns Needed
- For each table, identify which columns are needed
- Verify column names and types in the schema

### Step 4: Build the FROM Clause
- Start with the main table
- Add necessary JOINs based on relationships

### Step 5: Build the WHERE Clause
- Add filters based on the question
- Use evidence to disambiguate terms

### Step 6: Build the SELECT Clause
- Add columns to select or aggregate
- Apply any calculations needed

### Step 7: Add GROUP BY if Needed
- If using aggregation, add appropriate GROUP BY

### Step 8: Add ORDER BY if Needed
- Include sorting if specified in the question
- NULL handling per {DATABASE_TYPE} directives

### Step 9: Add LIMIT if Needed
- Include row limiting if specified

### Step 10: Assemble Final Query
- Combine all parts into a single, valid SQL query

## TECHNICAL NOTES
- Quote columns with spaces/special chars per {DATABASE_TYPE} syntax
- NULL handling follows {DATABASE_TYPE} rules specified in directives
- For division: Check denominator for IS NOT NULL AND <> 0

Here are some examples

==========================
Example 1
**************************
[Database schema]
【Schema】
-- Restaurant information system with location details
CREATE TABLE generalinfo (
id_restaurant INTEGER -- PRIMARY KEY
-- Unique identifier for the restaurant, serving as the primary key.
food_type TEXT
-- The type of food served by the restaurant.
-- Examples: thai
city TEXT
-- The city where the restaurant is located.
);

-- Location details for restaurants
CREATE TABLE location (
id_restaurant INTEGER -- PRIMARY KEY
-- Unique identifier for the restaurant, matching generalinfo.
street_name TEXT
-- The street name where the restaurant is located.
-- Examples: ave, san pablo ave, pablo ave
city TEXT
-- The city where the restaurant is located.
);

【Foreign keys】
location.id_restaurant=generalinfo.id_restaurant

**************************
[Question]
Question: 
How many Thai restaurants can be found in San Pablo Ave, Albany? 

[Evidence]
Thai restaurant refers to food_type = 'thai'; San Pablo Ave Albany refers to street_name = 'san pablo ave' AND T1.city = 'albany'

**************************
[Answer]

Repeating the question and evidence, and generating the SQL step-by-step.
**Question**: How many Thai restaurants can be found in San Pablo Ave, Albany? 
**Evidence**: Thai restaurant refers to food_type = 'thai'; San Pablo Ave Albany refers to street_name = 'san pablo ave' AND T1.city = 'albany'

**Step-by-Step SQL Construction:**

**Step 1: Understand the Question**
- We need to count Thai restaurants
- The restaurants must be located on San Pablo Ave in Albany
- This is a counting query (COUNT)

**Step 2: Identify Required Tables**
- generalinfo table: Contains food_type and city information
- location table: Contains street_name information
- Both tables are needed as the conditions span across them

**Step 3: Determine Columns Needed**
- From generalinfo: id_restaurant, food_type, city
- From location: id_restaurant, street_name
- These columns will be used for joining and filtering

**Step 4: Build the FROM Clause**
- Start with generalinfo as the main table (contains food_type)
- JOIN with location table on id_restaurant
- SQL so far: FROM generalinfo AS T1 INNER JOIN location AS T2 ON T1.id_restaurant = T2.id_restaurant

**Step 5: Build the WHERE Clause**
- Filter for Thai restaurants: T1.food_type = 'thai'
- Filter for Albany city: T1.city = 'albany'
- Filter for San Pablo Ave: T2.street_name = 'san pablo ave'
- SQL so far: WHERE T1.food_type = 'thai' AND T1.city = 'albany' AND T2.street_name = 'san pablo ave'

**Step 6: Build the SELECT Clause**
- We need to count restaurants
- Use COUNT on id_restaurant
- SQL so far: SELECT COUNT(T1.id_restaurant)

**Step 7: Add GROUP BY if Needed**
- No grouping needed as we're counting all matching records

**Step 8: Add ORDER BY if Needed**
- No ordering needed for a COUNT query

**Step 9: Add LIMIT if Needed**
- No limit needed

**Step 10: Assemble Final Query**
- Combine all parts into the final SQL query

**Final Example1 Answer**
SELECT COUNT(T1.id_restaurant) FROM generalinfo AS T1 INNER JOIN location AS T2 ON T1.id_restaurant = T2.id_restaurant WHERE T1.food_type = 'thai' AND T1.city = 'albany' AND T2.street_name = 'san pablo ave'


==========================
Example 2
**************************
[Database schema]
【Schema】
-- Banking system with client and district information
CREATE TABLE account (
account_id INT -- PRIMARY KEY
-- Unique identifier for the account.
district_id INT
-- Reference to the district where account was opened.
frequency VARCHAR
-- Frequency of transactions or statements.
date DATE
-- Date when the account was opened.
);

CREATE TABLE client (
client_id INT -- PRIMARY KEY
-- Unique identifier for the client.
gender CHAR
-- Gender of the client (M/F).
birth_date DATE
-- Birth date of the client.
district_id INT
-- District where the client resides.
);

CREATE TABLE district (
district_id INT -- PRIMARY KEY
-- Unique identifier for the district.
a4 VARCHAR
-- District attribute A4.
a11 VARCHAR
-- Average salary in the district.
);

【Foreign keys】
account.district_id=district.district_id
client.district_id=district.district_id

**************************
[Question]
Question: What is the gender of the youngest client who opened account in the lowest average salary branch?
EVIDENCE: Given that Later birthdate refers to younger age; A11 refers to average salary

**************************
[Answer]

Repeating the question and evidence, and generating the SQL step-by-step.
**Question**: What is the gender of the youngest client who opened account in the lowest average salary branch?
**Evidence**: Given that Later birthdate refers to younger age; A11 refers to average salary

**Step-by-Step SQL Construction:**

**Step 1: Understand the Question**
- We need to find the gender of a specific client
- The client must be the youngest (latest birth_date)
- The client must be in the branch with the lowest average salary (minimum A11)
- This requires finding minimums and selecting a single record

**Step 2: Identify Required Tables**
- client table: Contains gender and birth_date
- district table: Contains A11 (average salary)
- Both tables are connected through district_id

**Step 3: Determine Columns Needed**
- From client: gender, birth_date, district_id
- From district: district_id, A11
- These will be used for joining, sorting, and selecting

**Step 4: Build the FROM Clause**
- Start with client table as the main table (contains gender we need)
- JOIN with district table on district_id
- SQL so far: FROM client AS T1 INNER JOIN district AS T2 ON T1.district_id = T2.district_id

**Step 5: Build the WHERE Clause**
- No explicit WHERE conditions needed
- All filtering will be done through sorting and limiting

**Step 6: Build the SELECT Clause**
- We need only the gender column
- SQL so far: SELECT T1.gender

**Step 7: Add GROUP BY if Needed**
- No grouping needed as we're selecting a single record

**Step 8: Add ORDER BY if Needed**
- First sort by A11 ASC to get lowest salary branch first
- Then sort by birth_date DESC to get youngest (latest birth date) first
- SQL so far: ORDER BY T2.A11 ASC NULLS LAST, T1.birth_date DESC NULLS FIRST (for PostgreSQL/MySQL)\n- For SQLite: ORDER BY T2.A11 ASC, T1.birth_date DESC

**Step 9: Add LIMIT if Needed**
- We need only one record (the first after sorting)
- SQL so far: LIMIT 1

**Step 10: Assemble Final Query**
- Combine all parts into the final SQL query

**Final Example2 Answer**
-- For PostgreSQL/MySQL/MariaDB:
SELECT T1.gender FROM client AS T1 INNER JOIN district AS T2 ON T1.district_id = T2.district_id ORDER BY T2.A11 ASC NULLS LAST, T1.birth_date DESC NULLS FIRST LIMIT 1
-- For SQLite:
SELECT T1.gender FROM client AS T1 INNER JOIN district AS T2 ON T1.district_id = T2.district_id ORDER BY T2.A11 ASC, T1.birth_date DESC LIMIT 1


==========================
Example 3
**************************
[Database schema]
【Schema】
-- Games and hosting cities information
CREATE TABLE games (
id INTEGER -- PRIMARY KEY
-- Unique identifier for the game event.
games_year INTEGER
-- The year when the game was held.
);

CREATE TABLE games_city (
games_id INTEGER
-- Reference to the game.
city_id INTEGER
-- Reference to the city that hosted the game.
);

CREATE TABLE city (
id INTEGER -- PRIMARY KEY
-- Unique identifier for the city.
city_name TEXT
-- Name of the city.
-- Examples: London
);

【Foreign keys】
games_city.city_id=city.id
games_city.games_id=games.id

**************************
[Question]
Question:
From 1900 to 1992, how many games did London host?

[Evidence]
From 1900 to 1992 refers to games_year BETWEEN 1900 AND 1992; London refers to city_name = 'London'; games refer to games_name;

**************************
[Answer]

Repeating the question and evidence, and generating the SQL step-by-step.
**Question**: From 1900 to 1992, how many games did London host?
**Evidence**: From 1900 to 1992 refers to games_year BETWEEN 1900 AND 1992; London refers to city_name = 'London'; games refer to games_name;

**Step-by-Step SQL Construction:**

**Step 1: Understand the Question**
- We need to count games
- Games must be hosted in London
- Games must be between years 1900 and 1992
- This is a counting query with multiple conditions

**Step 2: Identify Required Tables**
- games table: Contains games_year
- games_city table: Links games to cities
- city table: Contains city_name
- All three tables are needed to connect games to city names

**Step 3: Determine Columns Needed**
- From games: id, games_year
- From games_city: games_id, city_id
- From city: id, city_name
- These will be used for joining and filtering

**Step 4: Build the FROM Clause**
- Start with games_city as the linking table
- JOIN with city table on city_id
- JOIN with games table on games_id
- SQL so far: FROM games_city AS T1 INNER JOIN city AS T2 ON T1.city_id = T2.id INNER JOIN games AS T3 ON T1.games_id = T3.id

**Step 5: Build the WHERE Clause**
- Filter for London: T2.city_name = 'London'
- Filter for year range: T3.games_year BETWEEN 1900 AND 1992
- SQL so far: WHERE T2.city_name = 'London' AND T3.games_year BETWEEN 1900 AND 1992

**Step 6: Build the SELECT Clause**
- We need to count games
- Use COUNT on games.id
- SQL so far: SELECT COUNT(T3.id)

**Step 7: Add GROUP BY if Needed**
- No grouping needed as we're counting all matching records

**Step 8: Add ORDER BY if Needed**
- No ordering needed for a COUNT query

**Step 9: Add LIMIT if Needed**
- No limit needed

**Step 10: Assemble Final Query**
- Combine all parts into the final SQL query

**Final Example3 Answer**
SELECT COUNT(T3.id) FROM games_city AS T1 INNER JOIN city AS T2 ON T1.city_id = T2.id INNER JOIN games AS T3 ON T1.games_id = T3.id WHERE T2.city_name = 'London' AND T3.games_year BETWEEN 1900 AND 1992


==========================
Example 4
**************************
[Database schema]
【Schema】
-- Airline flight and airport information
CREATE TABLE Airlines (
FL_DATE TEXT
-- Flight date in YYYY/M/D format.
-- Examples: 2018/8/9
ORIGIN TEXT
-- Airport code of origin.
-- Examples: SAN
DEST TEXT
-- Airport code of destination.
-- Examples: SAN
);

CREATE TABLE Airports (
Code TEXT -- PRIMARY KEY
-- Airport code identifier.
Description TEXT
-- Full description of the airport including city and name.
);

【Foreign keys】
Airlines.ORIGIN=Airports.Code
Airlines.DEST=Airports.Code

**************************
[Question]
Question: 
How many flights were there from San Diego International airport to Los Angeles International airport in the August of 2018? 

Evidence:
flights from refers to ORIGIN; San Diego International airport refers to Description = 'San Diego, CA: San Diego International'; flights to refers to DEST; Los Angeles International airport refers to Description = 'Los Angeles, CA: Los Angeles International'; in the August of 2018 refers to FL_DATE like '2018/8%';

**************************
[Answer]

Repeating the question and evidence, and generating the SQL step-by-step.
**Question**: How many flights were there from San Diego International airport to Los Angeles International airport in the August of 2018?
**Evidence**: flights from refers to ORIGIN; San Diego International airport refers to Description = 'San Diego, CA: San Diego International'; flights to refers to DEST; Los Angeles International airport refers to Description = 'Los Angeles, CA: Los Angeles International'; in the August of 2018 refers to FL_DATE like '2018/8%';

**Step-by-Step SQL Construction:**

**Step 1: Understand the Question**
- We need to count flights
- Flights must be from San Diego International to Los Angeles International
- Flights must be in August 2018
- This requires matching airport descriptions to codes

**Step 2: Identify Required Tables**
- Airlines table: Contains flight information (FL_DATE, ORIGIN, DEST)
- Airports table: Contains airport codes and descriptions
- Need to link airports to get codes for origin and destination

**Step 3: Determine Columns Needed**
- From Airlines: FL_DATE, ORIGIN, DEST
- From Airports: Code, Description
- These will be used for filtering and counting

**Step 4: Build the FROM Clause**
- Start with Airlines as the main table
- Need to link to Airports twice (for origin and destination)
- Due to complexity, we'll use subqueries instead of multiple joins
- SQL so far: FROM Airlines

**Step 5: Build the WHERE Clause**
- Filter for August 2018: FL_DATE LIKE '2018/8%'
- Filter for origin airport using subquery
- Filter for destination airport using subquery
- SQL so far: WHERE FL_DATE LIKE '2018/8%' AND ORIGIN = (subquery for San Diego) AND DEST = (subquery for LA)

**Step 6: Build the SELECT Clause**
- We need to count flights
- Use COUNT on FL_DATE
- SQL so far: SELECT COUNT(FL_DATE)

**Step 7: Add GROUP BY if Needed**
- No grouping needed as we're counting all matching records

**Step 8: Add ORDER BY if Needed**
- No ordering needed for a COUNT query

**Step 9: Add LIMIT if Needed**
- No limit needed

**Step 10: Assemble Final Query**
- Build subqueries for airport codes:
  - Origin: SELECT Code FROM Airports WHERE Description = 'San Diego, CA: San Diego International'
  - Destination: SELECT Code FROM Airports WHERE Description = 'Los Angeles, CA: Los Angeles International'
- Combine all parts into the final SQL query

**Final Example4 Answer**
SELECT COUNT(FL_DATE) FROM Airlines WHERE FL_DATE LIKE '2018/8%' AND ORIGIN = (SELECT Code FROM Airports WHERE Description = 'San Diego, CA: San Diego International') AND DEST = (SELECT Code FROM Airports WHERE Description = 'Los Angeles, CA: Los Angeles International')


==========================
Example 5
**************************
[Database schema]
【Schema】
-- Business inspection and violation tracking system
CREATE TABLE businesses (
business_id INTEGER -- PRIMARY KEY
-- Unique identifier for the business.
name TEXT
-- Name of the business/eatery.
);

CREATE TABLE inspections (
business_id INTEGER
-- Reference to the business being inspected.
score INTEGER
-- Inspection score (higher is better, 100 means met all standards).
date DATE
-- Date of the inspection.
-- Examples: 2014-01-24
);

CREATE TABLE violations (
business_id INTEGER
-- Reference to the business with violations.
date DATE
-- Date when the violation was recorded.
-- Examples: 2016-05-03
);

【Foreign keys】
inspections.business_id=businesses.business_id
violations.business_id=businesses.business_id

**************************
[Question]
Question: 
What are the names of the establishments that met all the required standards for 4 consecutive years? 

Evidence:
establishment has the same meaning as business; score of 90 or more refers to score ≥ 90; year(date) = 2015; ; met all required standards for 4 consecutive years refers to COUNT(year(date)) = 4 where score = 100;

**************************
[Answer]

Repeating the question and evidence, and generating the SQL step-by-step.
**Question**: What are the names of the establishments that met all the required standards for 4 consecutive years?
**Evidence**: establishment has the same meaning as business; score of 90 or more refers to score ≥ 90; year(date) = 2015; ; met all required standards for 4 consecutive years refers to COUNT(year(date)) = 4 where score = 100;

**Step-by-Step SQL Construction:**

**Step 1: Understand the Question**
- We need to find business names
- Businesses must have score = 100 (met all standards)
- Must have this score for 4 consecutive years
- This is a complex query requiring window functions

**Step 2: Identify Required Tables**
- businesses table: Contains business names
- inspections table: Contains scores and dates
- Both tables are needed to link scores to business names

**Step 3: Determine Columns Needed**
- From businesses: business_id, name
- From inspections: business_id, score, date
- Need to extract year from date using STRFTIME

**Step 4: Build the FROM Clause**
- First, create a subquery to get distinct business names and years with score = 100
- Then apply window functions to identify consecutive years
- SQL structure will use nested subqueries

**Step 5: Build the WHERE Clause**
- Filter for score = 100 in the innermost query
- No additional WHERE clause in outer queries

**Step 6: Build the SELECT Clause**
- Innermost: SELECT DISTINCT name, STRFTIME('%Y', date) AS years
- Middle: Add row_number() for consecutive year detection
- Outermost: SELECT DISTINCT name after grouping

**Step 7: Add GROUP BY if Needed**
- Group by name and a calculated consecutive year group
- Use date arithmetic to identify consecutive year sequences

**Step 8: Add ORDER BY if Needed**
- Order by years in the window function
- No final ordering needed

**Step 9: Add LIMIT if Needed**
- No limit needed

**Step 10: Assemble Final Query**
- Build nested structure:
  1. Inner query: Get distinct name/year combinations with score = 100
  2. Middle query: Add row numbers partitioned by name, ordered by year
  3. Outer query: Group by name and consecutive year groups, count = 4
- Combine all parts into the final SQL query

**Final Example5 Answer**
SELECT DISTINCT T4.name FROM ( SELECT T3.name, T3.years, row_number() OVER (PARTITION BY T3.name ORDER BY T3.years) AS rowNumber FROM ( SELECT DISTINCT name, STRFTIME('%Y', `date`) AS years FROM inspections AS T1 INNER JOIN businesses AS T2 ON T1.business_id = T2.business_id WHERE T1.score = 100 ) AS T3 ) AS T4 GROUP BY T4.name, date(T4.years || '-01-01', '-' || (T4.rowNumber - 1) || ' years') HAVING COUNT(T4.years) = 4

==========================================================================

Apply the step-by-step methodology to generate the SQL query.

---
**Question**
{QUESTION}

---
**Database type**
{DATABASE_TYPE}

---
**Schema**
{DATABASE_SCHEMA}

---
**Directives**
{DIRECTIVES}

---
**Evidence**
{EVIDENCE}

---
**Gold Examples**
{EXAMPLE_SHOTS}

---
**Answer**
[Output ONLY the final SQL query]