# Copyright (c) 2025 Marco Pancotti
# This file is part of Thoth and is released under the MIT License.
# See the LICENSE.md file in the project root for full license information.

version: '3.8'

services:
  # === BACKEND SERVICE ===
  backend:
    build:
      context: .
      dockerfile: docker/backend.Dockerfile
      args:
        DOCKER_BUILDKIT: 1
        BUILDKIT_INLINE_CACHE: 1
    image: thoth-backend:latest
    container_name: thoth-backend
    restart: always
    # Port removed - backend only accessible through proxy
    volumes:
      - thoth-backend-db:/app/backend_db
      - thoth-shared-data:/app/data
      - ./data_exchange:/app/data_exchange
      - thoth-logs:/app/logs
      - backend-static:/vol/static
      - backend-media:/vol/media
      - thoth-secrets:/secrets
      - ./config.yml.local:/app/config.yml.local:ro
    env_file: .env.docker
    environment:
      - HOST_IP=host.docker.internal
      - DOCKER_ENV=development
      - DB_NAME_DOCKER=/app/backend_db/db.sqlite3
      - FRONTEND_URL=http://localhost:${FRONTEND_PORT:-3040}
    networks:
      - thoth-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/admin/login/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 1200s  # 20 minutes for initial setup with AI operations
    depends_on:
      - thoth-qdrant

  # === FRONTEND SERVICE ===
  frontend:
    build:
      context: ./frontend
      dockerfile: ../docker/frontend.Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
        NEXT_PUBLIC_DJANGO_SERVER: http://localhost:${BACKEND_PORT:-8040}
        NEXT_PUBLIC_SQL_GENERATOR_URL: http://localhost:${SQL_GENERATOR_PORT:-8020}
    image: thoth-frontend:latest
    container_name: thoth-frontend
    restart: always
    ports:
      - "${FRONTEND_PORT:-3040}:3000"
    volumes:
      - frontend-cache:/app/.next/cache
      - ./frontend/public:/app/public:ro
      - thoth-secrets:/secrets
      - ./data_exchange:/app/data_exchange:ro
    env_file: .env.docker
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
      - DJANGO_SERVER=http://proxy:80
      - SQL_GENERATOR_URL=http://sql-generator:8020
      - DOCKER_CONTAINER=true
      - HOST_IP=host.docker.internal
      - NEXT_PUBLIC_DJANGO_SERVER=http://localhost:${BACKEND_PORT:-8040}
      - NEXT_PUBLIC_SQL_GENERATOR_URL=http://localhost:${SQL_GENERATOR_PORT:-8020}
    networks:
      - thoth-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - backend
      - sql-generator

  # === SQL GENERATOR SERVICE ===
  sql-generator:
    build:
      context: .
      dockerfile: docker/sql-generator.Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: thoth-sql-generator:latest
    container_name: thoth-sql-generator
    restart: always
    ports:
      - "${SQL_GENERATOR_PORT:-8020}:8020"
    volumes:
      - thoth-shared-data:/app/data
      - ./data_exchange:/app/data_exchange
      - thoth-logs:/app/logs
      - thoth-secrets:/secrets
    env_file: .env.docker
    environment:
      - DOCKER_CONTAINER=true
      - HOST_IP=host.docker.internal
      - PORT=8020
      - DJANGO_SERVER=http://backend:8000
      - VECTOR_DB_HOST=thoth-qdrant
      - VECTOR_DB_PORT=6333
      - DB_ROOT_PATH=/app/data
      - FRONTEND_LOGGING_LEVEL=DEBUG
    networks:
      - thoth-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - backend
      - thoth-qdrant

  # === PROXY SERVICE ===
  proxy:
    build:
      context: ./backend/proxy
      dockerfile: ../../docker/proxy.Dockerfile
    image: thoth-proxy:latest
    container_name: thoth-proxy
    restart: always
    ports:
      - "${WEB_PORT:-8040}:80"
    volumes:
      - backend-static:/vol/static:ro
      - backend-media:/vol/media:ro
      - ./data_exchange:/vol/data_exchange:ro
    environment:
      - APP_HOST=backend
      - APP_PORT=8000
      - FRONTEND_HOST=frontend
      - FRONTEND_PORT=3000
      - SQL_GEN_HOST=sql-generator
      - SQL_GEN_PORT=8020
      - DEBUG=False
    networks:
      - thoth-network
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_started
      sql-generator:
        condition: service_started

  # === VECTOR DATABASE SERVICE ===
  thoth-qdrant:
    image: qdrant/qdrant:latest
    container_name: thoth-qdrant
    restart: always
    ports:
      - "6333:6333"
    volumes:
      - qdrant-data:/qdrant/storage
      - ./backend/qdrant_storage:/qdrant/storage_backup:ro
    networks:
      - thoth-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  backend-static:
    name: thoth-backend-static
    external: true
  backend-media:
    name: thoth-backend-media
    external: true
  frontend-cache:
    name: thoth-frontend-cache
    external: true
  qdrant-data:
    name: thoth-qdrant-data
    external: true
  thoth-secrets:
    name: thoth-secrets
    external: true
  thoth-backend-db:
    name: thoth-backend-db
  thoth-logs:
    name: thoth-logs
  thoth-shared-data:
    name: thoth-shared-data
    external: true

networks:
  thoth-network:
    external: true
    name: thoth-network