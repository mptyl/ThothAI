# Copyright (c) 2025 Marco Pancotti
# This file is part of Thoth and is released under the MIT License.
# See the LICENSE.md file in the project root for full license information.

version: '3.8'

services:
  # === SECRETS INITIALIZATION SERVICE ===
  init-secrets:
    build:
      context: .
      dockerfile: docker/init-secrets.Dockerfile
    image: thoth-init-secrets:latest
    container_name: thoth-init-secrets
    volumes:
      - thoth-secrets:/secrets
    networks:
      - thoth-network
    profiles:
      - init
    restart: "no"

  # === BACKEND SERVICE ===
  backend:
    build:
      context: ./backend
      dockerfile: ../docker/backend.Dockerfile
      args:
        DOCKER_BUILDKIT: 1
        BUILDKIT_INLINE_CACHE: 1
    image: thoth-backend:latest
    container_name: thoth-backend
    restart: always
    ports:
      - "8040:8000"
    volumes:
      - ./exports:/app/exports
      - ./logs/backend:/app/logs
      - ./data:/app/data
      - ./backend/setup_csv:/app/setup_csv
      - backend-static:/vol/static
      - backend-media:/vol/media
      - thoth-secrets:/secrets
    env_file: .env.docker
    environment:
      - IS_DOCKER=True
      - HOST_IP=host.docker.internal
      - DOCKER_ENV=1
    networks:
      - thoth-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/admin/login/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s
    depends_on:
      - thoth-qdrant

  # === FRONTEND SERVICE ===
  frontend:
    build:
      context: ./frontend
      dockerfile: ../docker/frontend.Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
        NEXT_PUBLIC_DJANGO_SERVER: http://localhost:8040
        NEXT_PUBLIC_SQL_GENERATOR_URL: http://localhost:8005
    image: thoth-frontend:latest
    container_name: thoth-frontend
    restart: always
    ports:
      - "3001:3000"
    volumes:
      - ./logs/frontend:/app/logs
      - frontend-cache:/app/.next/cache
      - ./frontend/public:/app/public:ro
    env_file: .env.docker
    environment:
      - NODE_ENV=production
      - DJANGO_SERVER=http://proxy:80
      - SQL_GENERATOR_URL=http://sql-generator:8005
      - DOCKER_CONTAINER=true
      - HOST_IP=host.docker.internal
    networks:
      - thoth-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - backend
      - sql-generator

  # === SQL GENERATOR SERVICE ===
  sql-generator:
    build:
      context: ./frontend/sql_generator
      dockerfile: ../../docker/sql-generator.Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: thoth-sql-generator:latest
    container_name: thoth-sql-generator
    restart: always
    ports:
      - "8005:8005"
    volumes:
      - ./data:/app/data
      - ./logs/sql-generator:/app/logs
    env_file: .env.docker
    environment:
      - DOCKER_CONTAINER=true
      - HOST_IP=host.docker.internal
      - PORT=8005
    networks:
      - thoth-network
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # === PROXY SERVICE ===
  proxy:
    build:
      context: ./backend/proxy
      dockerfile: ../../docker/proxy.Dockerfile
    image: thoth-proxy:latest
    container_name: thoth-proxy
    restart: always
    ports:
      - "${WEB_PORT:-80}:80"
    volumes:
      - backend-static:/vol/static:ro
      - backend-media:/vol/media:ro
      - ./exports:/vol/exports:ro
    environment:
      - APP_HOST=backend
      - APP_PORT=8000
      - FRONTEND_HOST=frontend
      - FRONTEND_PORT=3000
      - SQL_GEN_HOST=sql-generator
      - SQL_GEN_PORT=8005
      - DEBUG=False
    networks:
      - thoth-network
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_started
      sql-generator:
        condition: service_started

  # === VECTOR DATABASE SERVICE ===
  thoth-qdrant:
    image: qdrant/qdrant:latest
    container_name: thoth-qdrant
    restart: always
    ports:
      - "6333:6333"
    volumes:
      - qdrant-data:/qdrant/storage
      - ./backend/qdrant_storage:/qdrant/storage_backup:ro
    networks:
      - thoth-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  backend-static:
    name: thoth-backend-static
  backend-media:
    name: thoth-backend-media
  frontend-cache:
    name: thoth-frontend-cache
  qdrant-data:
    name: thoth-qdrant-data
  thoth-secrets:
    name: thoth-secrets

networks:
  thoth-network:
    external: true
    name: thoth-network