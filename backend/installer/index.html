<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThothAI Database Configuration</title>
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css" rel="stylesheet">
    <style>
        :root {
            --ct-primary: #4a90a4;
            --ct-primary-rgb: 74, 144, 164;
            --ct-secondary: #67a7bb;
            --ct-success: #00b894;
            --ct-info: #00cec9;
            --ct-warning: #fdcb6e;
            --ct-danger: #e17055;
            --ct-light: #f8f9fa;
            --ct-dark: #2d3748;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Nunito', sans-serif;
            margin: 0;
            padding: 0.5rem;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .main-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 8px;
            margin: 0 auto;
            max-width: 1100px;
            width: 100%;
            max-height: 95vh;
            overflow-y: auto;
        }

        .thoth-container {
            display: flex;
            flex-direction: row;
            gap: 0.8rem;
            align-items: flex-start;
        }

        .thoth-image-container {
            flex: 0 0 150px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .thoth-image {
            width: 100%;
            max-width: 150px;
            height: auto;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .content-container {
            flex: 1;
            min-width: 0;
        }

        .feature-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            background: white;
            margin-bottom: 0.4rem;
        }

        .feature-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .card-header {
            background: linear-gradient(135deg, var(--ct-primary) 0%, var(--ct-secondary) 100%);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            border: none;
            padding: 0.4rem;
        }

        .card-body {
            padding: 6px;
        }

        .form-check-input:checked {
            background-color: var(--ct-primary);
            border-color: var(--ct-primary);
        }

        .form-check-input.qdrant-locked:checked {
            background-color: var(--ct-success);
            border-color: var(--ct-success);
            opacity: 0.9;
            cursor: not-allowed;
        }

        .form-check-input.qdrant-locked + .form-check-label {
            opacity: 0.9;
            font-weight: 600;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--ct-primary) 0%, var(--ct-secondary) 100%);
            border: none;
            border-radius: 6px;
            font-weight: 600;
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #3a7a8e 0%, #5a9fb3 100%);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--ct-success) 0%, #00a085 100%);
            border: none;
            border-radius: 6px;
            font-weight: 600;
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
        }

        .btn-outline-success {
            border-color: var(--ct-success);
            color: var(--ct-success);
            border-radius: 6px;
            font-weight: 600;
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
        }

        .btn-outline-success:hover {
            background: var(--ct-success);
            border-color: var(--ct-success);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--ct-danger) 0%, #d63447 100%);
            border: none;
            border-radius: 6px;
            font-weight: 600;
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #d63447 0%, #c0392b 100%);
            transform: translateY(-1px);
        }

        .alert {
            padding: 0.3rem;
            margin-bottom: 0.3rem;
            font-size: 0.85rem;
        }

        .alert-info {
            background-color: rgba(0, 206, 201, 0.1);
            border-color: var(--ct-info);
            color: #0d5d5a;
            border-radius: 6px;
        }

        .docker-status {
            margin-top: 0.3rem;
            padding: 0.4rem;
            border-radius: 8px;
            background: white;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        #dockerMessage, #dockerSisterMessage {
            width: 80%;
            display: inline-block;
        }

        .docker-status.running {
            background: rgba(0, 206, 201, 0.05);
            border-color: var(--ct-info);
            color: #0d5d5a;
        }

        .docker-status.completed {
            background: rgba(0, 184, 148, 0.05);
            border-color: var(--ct-success);
            color: #0d4d3f;
        }

        .docker-status.error {
            background: rgba(225, 112, 85, 0.05);
            border-color: var(--ct-danger);
            color: #8b2635;
        }

        .section-title {
            color: var(--ct-primary);
            font-weight: 700;
            margin-bottom: 0.3rem;
            position: relative;
            padding-bottom: 3px;
            font-size: 1.05rem;
        }

        .section-title:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background: linear-gradient(90deg, var(--ct-primary) 0%, var(--ct-secondary) 100%);
            border-radius: 2px;
        }

        .form-check-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 0.1rem;
        }

        .form-check-compact {
            margin-bottom: 2px !important;
        }

        .progress {
            height: 8px;
            border-radius: 4px;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--ct-primary) 0%, var(--ct-secondary) 100%);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .mdi-spin {
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        .row {
            --bs-gutter-y: 0.2rem;
        }
        
        .form-check {
            margin-bottom: 0.15rem !important;
        }
        
        h1, h2, h3, h4, h5, h6 {
            margin-bottom: 0.2rem !important;
            margin-top: 0.2rem !important;
        }
        
        .mb-0 { margin-bottom: 0 !important; }
        .mb-1 { margin-bottom: 0.1rem !important; }
        .mb-2 { margin-bottom: 0.2rem !important; }
        .mt-0 { margin-top: 0 !important; }
        .mt-1 { margin-top: 0.1rem !important; }
        .mt-2 { margin-top: 0.2rem !important; }

        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }

            .main-container {
                padding: 10px;
                max-height: 98vh;
            }

            .thoth-container {
                flex-direction: column;
                gap: 0.5rem;
                align-items: center;
            }

            .thoth-image-container {
                flex: none;
                width: 100%;
                max-width: 150px;
            }

            .thoth-image {
                max-width: 150px;
            }

            .card-header {
                padding: 0.5rem;
            }

            .card-body {
                padding: 6px;
            }

            .feature-card {
                margin-bottom: 0.4rem;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="thoth-container">
            <!-- Thoth Image at the left -->
            <div class="thoth-image-container">
                <img src="/static/images/dio-thoth-low.png" alt="Thoth - Egyptian God" class="thoth-image">
            </div>
            
            <!-- Content at the right of the image -->
            <div class="content-container">
                <!-- Header Section -->
                <div class="feature-card">
                    <div class="card-header text-center">
                        <h5 class="mb-0"><i class="mdi mdi-database-cog"></i> ThothAI Database Configuration</h5>
                        <small class="d-block mt-0">Configure SQL databases for your ThothAI project</small>
                    </div>
                </div>

                <div id="alertContainer"></div>

                <form id="dbConfigForm">
                    <!-- Database Selezionabili -->
                    <div class="feature-card">
                        <div class="card-body">
                            <h6 class="section-title">
                                <i class="mdi mdi-server"></i> SQL Databases
                            </h5>
                            <div class="alert alert-info" role="alert">
                                <i class="mdi mdi-information"></i> <strong>Note:</strong> SQLite is always included as the base option for testing and development.
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check form-check-compact">
                                        <input class="form-check-input qdrant-locked" type="checkbox" value="sqlite" id="sqlite" name="databases" checked>
                                        <label class="form-check-label" for="sqlite">SQLite <small class="text-muted">(always included)</small></label>
                                    </div>
                                    <div class="form-check form-check-compact">
                                        <input class="form-check-input" type="checkbox" value="postgresql" id="postgresql" name="databases">
                                        <label class="form-check-label" for="postgresql">PostgreSQL</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-check-compact">
                                        <input class="form-check-input" type="checkbox" value="mariadb" id="mariadb" name="databases">
                                        <label class="form-check-label" for="mariadb">MariaDB</label>
                                    </div>
                                    <div class="form-check form-check-compact">
                                        <input class="form-check-input" type="checkbox" value="mysql" id="mysql" name="databases">
                                        <label class="form-check-label" for="mysql">MySQL</label>
                                    </div>
                                    <div class="form-check form-check-compact">
                                        <input class="form-check-input" type="checkbox" value="sqlserver" id="sqlserver" name="databases">
                                        <label class="form-check-label" for="sqlserver">SQL Server</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="feature-card">
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <!-- Configuration and Close buttons row -->
                                <div class="row g-1">
                                    <div class="col-6">
                                        <button type="submit" class="btn btn-primary w-100" id="submitBtn">
                                            <i class="mdi mdi-cog"></i> Update Configuration
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button type="button" class="btn btn-danger w-100" id="closeBtn">
                                            <i class="mdi mdi-close"></i> Close
                                        </button>
                                    </div>
                                </div>

                                <!-- Docker Deploy Buttons -->
                                <div class="row g-2 mt-0">
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-success w-100" id="dockerBtn">
                                            <i class="mdi mdi-rocket-launch"></i> Deploy Backend
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-outline-success w-100" id="dockerSisterBtn">
                                            <i class="mdi mdi-web"></i> Deploy Frontend
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Docker Status Backend -->
                            <div id="dockerStatus" class="docker-status" style="display: none;">
                                <h6 class="mb-1"><i class="mdi mdi-server"></i> Backend Deploy Status</h6>
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" id="dockerSpinner" style="display: none;"></div>
                                    <i class="mdi mdi-information me-2" id="dockerIcon"></i>
                                    <span id="dockerMessage">Ready</span>
                                </div>
                                <div class="progress mt-1" id="dockerProgress" style="display: none;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>

                            <!-- Docker Status Sister -->
                            <div id="dockerSisterStatus" class="docker-status" style="display: none;">
                                <h6 class="mb-1"><i class="mdi mdi-web"></i> Frontend Deploy Status</h6>
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" id="dockerSisterSpinner" style="display: none;"></div>
                                    <i class="mdi mdi-information me-2" id="dockerSisterIcon"></i>
                                    <span id="dockerSisterMessage">Ready</span>
                                </div>
                                <div class="progress mt-1" id="dockerSisterProgress" style="display: none;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // SQLite management always selected - prevents any modification
        document.getElementById('sqlite').addEventListener('click', function(e) {
            // Completely prevents click if trying to deselect
            if (this.checked) {
                e.preventDefault();
                return false;
            }
            // If not selected, allow selecting it
            this.checked = true;
        });
        
        // Backup: ensure it always stays checked even with other events
        document.getElementById('sqlite').addEventListener('change', function() {
            this.checked = true;
        });
        
        // Also prevents changes via keyboard
        document.getElementById('sqlite').addEventListener('keydown', function(e) {
            if (e.key === ' ' || e.key === 'Enter') {
                e.preventDefault();
                return false;
            }
        });

        // Weaviate removed: mutual exclusivity no longer needed

        // Docker Deploy Management
        let dockerStatusInterval = null;
        let dockerSisterStatusInterval = null;

        // Load previous configuration
        async function loadPreviousConfig() {
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    const config = await response.json();

                    // Set traditional databases
                    if (config.databases) {
                        config.databases.forEach(db => {
                            const checkbox = document.getElementById(db);
                            if (checkbox) checkbox.checked = true;
                        });
                    }

                    // Vector database is always Qdrant (no need to set anything)
                }
            } catch (error) {
                console.log('No previous configuration found');
            }
        }

        // Show alert
        function showAlert(message, type = 'success', persistent = false) {
            const alertContainer = document.getElementById('alertContainer');
            // Convert newlines to HTML breaks for better formatting
            const formattedMessage = message.replace(/\n/g, '<br>');
            const dismissButton = persistent ? '' : '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
            const alertHtml = `
                <div class="alert alert-${type} ${persistent ? '' : 'alert-dismissible'} fade show" role="alert" style="white-space: pre-line; padding: 0.4rem; margin-bottom: 0.4rem;">
                    <i class="mdi mdi-${type === 'success' ? 'check-circle' : type === 'warning' ? 'alert' : 'alert-circle'}"></i> ${formattedMessage}
                    ${dismissButton}
                </div>
            `;
            alertContainer.innerHTML = alertHtml;

            // Auto-dismiss after 5 seconds only if not persistent
            if (!persistent) {
                setTimeout(() => {
                    const alert = alertContainer.querySelector('.alert');
                    if (alert && alert.classList.contains('alert-dismissible')) {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }, 5000);
            }
        }

        function updateDockerStatus(status) {
            const dockerStatus = document.getElementById('dockerStatus');
            const dockerSpinner = document.getElementById('dockerSpinner');
            const dockerIcon = document.getElementById('dockerIcon');
            const dockerMessage = document.getElementById('dockerMessage');
            const dockerBtn = document.getElementById('dockerBtn');
            const dockerProgress = document.getElementById('dockerProgress');

            dockerStatus.style.display = 'block';

            // Reset classes
            dockerStatus.className = 'docker-status';

            // If it's a new deployment (started), hide any previous success messages
            if (status.status === 'started') {
                // Hide previous message if it was successful
                const previousSuccess = dockerStatus.classList.contains('success');
                if (previousSuccess) {
                    dockerStatus.style.display = 'none';
                    return; // Don't show "started" message, start polling directly
                }
            }

            if (status.status === 'running') {
                dockerStatus.classList.add('running');
                dockerSpinner.style.display = 'inline-block';
                dockerIcon.className = 'mdi mdi-clock-outline me-2';
                dockerBtn.disabled = true;
                dockerBtn.innerHTML = '<i class="mdi mdi-clock-outline"></i> Deploy in progress...';
                dockerProgress.style.display = 'block';

                // During execution, show only message without timestamp
                dockerMessage.textContent = status.message;

                // Simulate progress based on phase
                let progressWidth = '25%';
                if (status.phase === 'building') progressWidth = '50%';
                else if (status.phase === 'starting') progressWidth = '75%';
                dockerProgress.querySelector('.progress-bar').style.width = progressWidth;

            } else if (status.status === 'completed') {
                dockerStatus.classList.add('completed');
                dockerSpinner.style.display = 'none';
                dockerIcon.className = 'mdi mdi-check-circle me-2';
                dockerBtn.disabled = false;
                dockerBtn.innerHTML = '<i class="mdi mdi-rocket-launch"></i> Deploy Backend';
                dockerProgress.style.display = 'none';

                // Add timestamp to final message
                const now = new Date();
                const timestamp = now.toLocaleString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                dockerMessage.textContent = `[${timestamp}] ${status.message}`;

                // Message remains visible until next deployment

            } else if (status.status === 'error') {
                dockerStatus.classList.add('error');
                dockerSpinner.style.display = 'none';
                dockerIcon.className = 'mdi mdi-alert-circle me-2';
                dockerBtn.disabled = false;
                dockerBtn.innerHTML = '<i class="mdi mdi-rocket-launch"></i> Deploy Backend';
                dockerProgress.style.display = 'none';

                // Add timestamp to final error message
                const now = new Date();
                const timestamp = now.toLocaleString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                dockerMessage.textContent = `[${timestamp}] ${status.message}`;

            } else {
                dockerSpinner.style.display = 'none';
                dockerIcon.className = 'mdi mdi-information me-2';
                dockerBtn.disabled = false;
                dockerBtn.innerHTML = '<i class="mdi mdi-rocket-launch"></i> Deploy Backend';
                dockerProgress.style.display = 'none';
                dockerMessage.textContent = status.message;
            }
        }

        function updateDockerSisterStatus(status) {
            const dockerSisterStatus = document.getElementById('dockerSisterStatus');
            const dockerSisterSpinner = document.getElementById('dockerSisterSpinner');
            const dockerSisterIcon = document.getElementById('dockerSisterIcon');
            const dockerSisterMessage = document.getElementById('dockerSisterMessage');
            const dockerSisterBtn = document.getElementById('dockerSisterBtn');
            const dockerSisterProgress = document.getElementById('dockerSisterProgress');

            dockerSisterStatus.style.display = 'block';

            // Reset classes
            dockerSisterStatus.className = 'docker-status';

            // If it's a new deployment (started), hide any previous success messages
            if (status.status === 'started') {
                // Hide previous message if it was successful
                const previousSuccess = dockerSisterStatus.classList.contains('success');
                if (previousSuccess) {
                    dockerSisterStatus.style.display = 'none';
                    return; // Don't show "started" message, start polling directly
                }
            }

            if (status.status === 'running') {
                dockerSisterStatus.classList.add('running');
                dockerSisterSpinner.style.display = 'inline-block';
                dockerSisterIcon.className = 'mdi mdi-clock-outline me-2';
                dockerSisterBtn.disabled = true;
                dockerSisterBtn.innerHTML = '<i class="mdi mdi-clock-outline"></i> Deploy in progress...';
                dockerSisterProgress.style.display = 'block';

                // During execution, show only message without timestamp
                dockerSisterMessage.textContent = status.message;

                // Simulate progress based on phase
                let progressWidth = '25%';
                if (status.phase === 'building') progressWidth = '50%';
                else if (status.phase === 'starting') progressWidth = '75%';
                dockerSisterProgress.querySelector('.progress-bar').style.width = progressWidth;

            } else if (status.status === 'completed') {
                dockerSisterStatus.classList.add('completed');
                dockerSisterSpinner.style.display = 'none';
                dockerSisterIcon.className = 'mdi mdi-check-circle me-2';
                dockerSisterBtn.disabled = false;
                dockerSisterBtn.innerHTML = '<i class="mdi mdi-web"></i> Deploy Frontend';
                dockerSisterProgress.style.display = 'none';

                // Add timestamp to final message
                const now = new Date();
                const timestamp = now.toLocaleString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                dockerSisterMessage.textContent = `[${timestamp}] ${status.message}`;

                // Message remains visible until next deployment

            } else if (status.status === 'error') {
                dockerSisterStatus.classList.add('error');
                dockerSisterSpinner.style.display = 'none';
                dockerSisterIcon.className = 'mdi mdi-alert-circle me-2';
                dockerSisterBtn.disabled = false;
                dockerSisterBtn.innerHTML = '<i class="mdi mdi-web"></i> Deploy Frontend';
                dockerSisterProgress.style.display = 'none';

                // Add timestamp to final error message
                const now = new Date();
                const timestamp = now.toLocaleString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                dockerSisterMessage.textContent = `[${timestamp}] ${status.message}`;

            } else {
                dockerSisterSpinner.style.display = 'none';
                dockerSisterIcon.className = 'mdi mdi-information me-2';
                dockerSisterBtn.disabled = false;
                dockerSisterBtn.innerHTML = '<i class="mdi mdi-web"></i> Deploy Frontend';
                dockerSisterProgress.style.display = 'none';
                dockerSisterMessage.textContent = status.message;
            }
        }

        async function startDockerDeploy() {
            // Feedback immediato al click
            const dockerBtn = document.getElementById('dockerBtn');
            const dockerStatus = document.getElementById('dockerStatus');
            const dockerSpinner = document.getElementById('dockerSpinner');
            const dockerIcon = document.getElementById('dockerIcon');
            const dockerMessage = document.getElementById('dockerMessage');
            const dockerProgress = document.getElementById('dockerProgress');
            
            // Mostra immediatamente lo stato di avvio
            dockerStatus.style.display = 'block';
            dockerStatus.className = 'docker-status running';
            dockerSpinner.style.display = 'inline-block';
            dockerIcon.className = 'mdi mdi-clock-outline me-2';
            dockerMessage.textContent = 'Preparing Docker Compose...';
            dockerBtn.disabled = true;
            dockerBtn.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Starting...';
            dockerProgress.style.display = 'block';
            dockerProgress.querySelector('.progress-bar').style.width = '10%';
            
            try {
                const response = await fetch('/api/docker-deploy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                updateDockerStatus(result);

                if (result.status === 'started') {
                    // Start status polling
                    dockerStatusInterval = setInterval(checkDockerStatus, 2000);
                }

            } catch (error) {
                updateDockerStatus({
                    status: 'error',
                    message: 'Server connection error',
                    phase: 'error'
                });
            }
        }

        async function checkDockerStatus() {
            try {
                const response = await fetch('/api/docker-status');
                const status = await response.json();
                updateDockerStatus(status);

                // Stop polling if process is completed or in error
                if (status.status === 'completed' || status.status === 'error') {
                    if (dockerStatusInterval) {
                        clearInterval(dockerStatusInterval);
                        dockerStatusInterval = null;
                    }
                }

            } catch (error) {
                console.error('Error checking Docker status:', error);
            }
        }

        async function startDockerDeploySister() {
            // Feedback immediato al click
            const dockerSisterBtn = document.getElementById('dockerSisterBtn');
            const dockerSisterStatus = document.getElementById('dockerSisterStatus');
            const dockerSisterSpinner = document.getElementById('dockerSisterSpinner');
            const dockerSisterIcon = document.getElementById('dockerSisterIcon');
            const dockerSisterMessage = document.getElementById('dockerSisterMessage');
            const dockerSisterProgress = document.getElementById('dockerSisterProgress');
            
            // Mostra immediatamente lo stato di avvio
            dockerSisterStatus.style.display = 'block';
            dockerSisterStatus.className = 'docker-status running';
            dockerSisterSpinner.style.display = 'inline-block';
            dockerSisterIcon.className = 'mdi mdi-clock-outline me-2';
            dockerSisterMessage.textContent = 'Preparing Frontend Docker Compose...';
            dockerSisterBtn.disabled = true;
            dockerSisterBtn.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Starting...';
            dockerSisterProgress.style.display = 'block';
            dockerSisterProgress.querySelector('.progress-bar').style.width = '10%';
            
            try {
                const response = await fetch('/api/docker-deploy-sister', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                updateDockerSisterStatus(result);

                if (result.status === 'started') {
                    // Start status polling
                    dockerSisterStatusInterval = setInterval(checkDockerSisterStatus, 2000);
                }

            } catch (error) {
                updateDockerSisterStatus({
                    status: 'error',
                    message: 'Server connection error',
                    phase: 'error'
                });
            }
        }

        async function checkDockerSisterStatus() {
            try {
                const response = await fetch('/api/docker-status-sister');
                const status = await response.json();
                updateDockerSisterStatus(status);

                // Stop polling if process is completed or in error
                if (status.status === 'completed' || status.status === 'error') {
                    if (dockerSisterStatusInterval) {
                        clearInterval(dockerSisterStatusInterval);
                        dockerSisterStatusInterval = null;
                    }
                }

            } catch (error) {
                console.error('Error checking sister Docker status:', error);
            }
        }

        // Form submit handling
        document.getElementById('dbConfigForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Updating...';
            submitBtn.disabled = true;

            // Collect selected data
            const databases = Array.from(document.querySelectorAll('input[name="databases"]:checked'))
                .map(cb => cb.value);
            
            // Ensure SQLite is always included
            if (!databases.includes('sqlite')) {
                databases.push('sqlite');
            }
            
            // Qdrant is the only vector database
            const vectordbs = ['qdrant'];

            try {
                const response = await fetch('/api/update-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        databases: databases,
                        vectordbs: vectordbs
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // Use the detailed message from backend if available
                    const message = result.message || 'Configuration updated successfully!';
                    // Make configuration success message persistent (stays on screen)
                    showAlert(message, 'success', true);
                    
                    // Show local warnings if any (also persistent)
                    if (result.local_warnings && result.local_warnings.length > 0) {
                        const warningMessage = '<br><br><strong>Local Development:</strong><br>' + 
                                              result.local_warnings.join('<br>');
                        setTimeout(() => {
                            showAlert(message + warningMessage, 'warning', true);
                        }, 100);
                    }
                } else {
                    showAlert(result.detail || 'Error during update', 'danger', false);
                }
            } catch (error) {
                showAlert('Server connection error', 'danger');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Event listener for Docker buttons
        document.getElementById('dockerBtn').addEventListener('click', startDockerDeploy);
        document.getElementById('dockerSisterBtn').addEventListener('click', startDockerDeploySister);

        // Event listener for Close button
        document.getElementById('closeBtn').addEventListener('click', async function() {
            const closeBtn = document.getElementById('closeBtn');
            const originalText = closeBtn.innerHTML;
            closeBtn.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Closing...';
            closeBtn.disabled = true;

            try {
                await fetch('/api/shutdown', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                // Show closing message
                showAlert('Server shutting down...', 'info');
                
                // After 2 seconds, replace page content
                setTimeout(() => {
                    document.body.innerHTML = `
                        <div style="
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            min-height: 100vh;
                            background: linear-gradient(135deg, #4a90a4 0%, #67a7bb 100%);
                            margin: 0;
                            font-family: 'Nunito', sans-serif;
                        ">
                            <div style="
                                background: white;
                                padding: 60px;
                                border-radius: 20px;
                                box-shadow: 0 20px 60px rgba(0,0,0,0.2);
                                text-align: center;
                                max-width: 500px;
                                width: 90%;
                            ">
                                <div style="
                                    width: 80px;
                                    height: 80px;
                                    background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    margin: 0 auto 30px auto;
                                ">
                                    <i class="mdi mdi-check" style="color: white; font-size: 40px;"></i>
                                </div>
                                <h1 style="
                                    color: #2d3748;
                                    margin-bottom: 20px;
                                    font-weight: 700;
                                    font-size: 2.5rem;
                                ">Server Closed</h1>
                                <p style="
                                    color: #6c757d;
                                    font-size: 1.2rem;
                                    margin-bottom: 30px;
                                    line-height: 1.6;
                                ">
                                    The ThothAI Database Installer server has been terminated successfully.<br>
                                    You can now close this browser window.
                                </p>
                                <div style="
                                    background: #f8f9fa;
                                    border-radius: 10px;
                                    padding: 20px;
                                    color: #495057;
                                    font-size: 0.95rem;
                                ">
                                    <strong>Good luck with ThothAI!</strong><br>
                                    Your database configuration has been saved successfully.
                                </div>
                            </div>
                        </div>
                    `;
                }, 2000);
                
            } catch (error) {
                closeBtn.innerHTML = originalText;
                closeBtn.disabled = false;
                showAlert('Error during server shutdown', 'danger');
            }
        });

        // Load configuration on page load
        document.addEventListener('DOMContentLoaded', loadPreviousConfig);
    </script>
</body>
</html>
