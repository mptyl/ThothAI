{% extends "vertical_base.html" %}
{% load static %}

{% block title %}Products{% endblock title %}

{% block extra_css %}
<link href="{% static 'css/thoth/datatables.min.css' %}" rel="stylesheet"  type="text/css"/>
{#    <link href="{% static 'css/vendor/dataTables.bootstrap5.min.css' %}" rel="stylesheet" type="text/css" />#}
<link href="{% static 'css/vendor/responsive.bootstrap5.min.css' %}" rel="stylesheet" type="text/css" />

<style>
    /* Enhanced styling for questions table - fit all columns in one line */
    #questions-datatable {
        table-layout: fixed;
        width: 100%;
    }
    
    /* Column width distribution - compact for better fit */
    #questions-datatable th:nth-child(1), /* Question */
    #questions-datatable td:nth-child(1) {
        width: 35%;
        max-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    #questions-datatable th:nth-child(2), /* SQL */
    #questions-datatable td:nth-child(2) {
        width: 35%;
        max-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    #questions-datatable th:nth-child(3), /* Evidence */
    #questions-datatable td:nth-child(3) {
        width: 20%;
        max-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    #questions-datatable th:nth-child(4), /* Action */
    #questions-datatable td:nth-child(4) {
        width: 10%;
        max-width: 0;
        text-align: center;
    }
    
    .evidence-cell {
        cursor: help;
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    /* Ensure proper column alignment - compact padding */
    #questions-datatable th,
    #questions-datatable td {
        vertical-align: middle;
        padding: 6px 8px;
        font-size: 0.875rem;
        line-height: 1.3;
    }
    
    /* Override pre/code styling to prevent overflow */
    #questions-datatable pre {
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        background: none;
        border: none;
        padding: 0;
        font-size: 0.875rem;
    }
    
    #questions-datatable code {
        background: none;
        color: #6f42c1;
        font-size: 0.875rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
    }
</style>

{% endblock %}

{% block page_title %}
{% include "partials/page-title.html" with page_title='Gold SQLs' sub_title='SQL Generation Context' %}
{% endblock %}

{% block content %}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-sm-5">
                        {% if user_is_editor %}
                        {# Link to the create question view #}
                        <a href="{% url 'thoth_ai_backend:create_question' %}" class="btn btn-danger mb-2"><i
                                class="mdi mdi-plus-circle me-2"></i> Add Gold SQL</a>
                        {% endif %}
                    </div>
                    <div class="col-sm-7">
                        <div class="text-sm-end">
                            {% if user_is_editor %}
                            <form method="POST" action="{% url 'thoth_ai_backend:delete_all_questions' %}" style="display: inline-block; margin-right: 5px;" onsubmit="return confirm('Are you sure you want to delete ALL Gold SQLs? This action cannot be undone.');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger mb-2"><i class="mdi mdi-delete-sweep me-2"></i> Delete All Gold SQLs</button>
                            </form>
                            <form method="POST" action="{% url 'thoth_ai_backend:import_questions_server_csv' %}" style="display: inline-block; margin-right: 5px;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-info mb-2">Import from CSV</button>
                            </form>
                            {% endif %}
                            <a href="{% url 'thoth_ai_backend:export_questions_csv' %}" class="btn btn-light mb-2">Export CSV</a>
                        </div>
                    </div><!-- end col-->
                </div>

                <div class="table-responsive">
                    <table class="table table-centered w-100 dt-responsive nowrap table-striped" id="questions-datatable">
                        <thead>
                            <tr>
                                {# Removed checkbox column #}
                                <th>Gold SQL</th>
                                <th>SQL</th>
                                <th>Evidence</th>
                                {% if user_is_editor %}
                                <th class="action-column" style="width: 45px;">Action</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {# Loop through the questions from the context #}
                            {% for question in questions %}
                            <tr>
                                {# Removed checkbox cell #}
                                <td title="{{ question.question }}">{{ question.question|truncatechars:50 }}</td>
                                <td title="{{ question.sql }}"><pre><code>{{ question.sql|truncatechars:60 }}</code></pre></td>
                                <td>
                                    {% if question.evidence %}
                                        <div class="evidence-cell" title="{{ question.evidence }}">
                                            {{ question.evidence|truncatechars:40 }}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">No evidence</span>
                                    {% endif %}
                                </td>
                                {% if user_is_editor %}
                                <td class="table-action">
                                    {# Link to update view #}
                                    <a href="{% url 'thoth_ai_backend:update_question' question_id=question.id %}" class="action-icon"> <i class="mdi mdi-square-edit-outline"></i></a>
                                    {# Link to delete confirmation view #}
                                    <a href="{% url 'thoth_ai_backend:confirm_delete_question' question_id=question.id %}" class="action-icon"> <i class="mdi mdi-delete"></i></a>
                                </td>
                                {% endif %}
                            </tr>
                            {% empty %}
                            <tr>
                                {# Adjusted colspan to 3 since we removed the checkbox column #}
                                <td>
                                    {% if error %}
                                    <div class="alert alert-error">
                                        {{ error }}
                                    </div>
                                    {% else %}
                                    No Gold SQLs found.
                                    {% endif %}
                                </td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div> <!-- end card-body-->
        </div> <!-- end card-->
    </div> <!-- end col -->
</div>
<!-- end row -->

{% endblock %}

{% block extra_javascript %}

<!-- Third party js -->
<script src = "{% static 'js/thoth/datatables.min.js' %}"></script>
    <!-- Removed dataTables.checkboxes.min.js as it's no longer needed -->
<!-- Third party js ends -->

<!-- Init js -->
<script src="{% static 'js/thoth/vdb.questions.js' %}"></script>
<!-- Init js end -->

{% endblock %}
