{% comment %}
Reusable partial for operation buttons with progress bar support.
This template handles the display of the button, its state, last run time,
progress bar during execution, and success/error messages after an HTMX request.

Context variables:
- container_id: The ID for the main container div.
- hx_url: The URL for the hx-post request.
- progress_url: The URL for polling progress updates (optional).
- button_text: The main text for the button.
- last_run: The timestamp of the last execution (datetime object).
- last_run_text: The text to display for the last run (e.g., "Last run on").
- never_run_text: The text to display if it has never been run.
- icon_class: The CSS class for the button icon (e.g., 'mdi mdi-refresh').
- button_class: The CSS class for the button color (e.g., 'btn-primary'). Defaults to 'btn-primary'.
- workspace: The workspace object.
- success_message: Message to display on success.
- error_message: Message to display on error.
- special_message: A special message for specific conditions (e.g., evidences upload).
- total_items: Total number of items to process (for progress calculation).
- successful_uploads: Number of successfully processed items.
- show_progress: Boolean to show progress bar instead of spinner.
{% endcomment %}

<div id="{{ container_id }}">
    {% if success_message or error_message or special_message %}
        {% if success_message %}
            <div class="alert alert-success" role="alert">
                {{ success_message }}
            </div>
        {% elif error_message %}
            <div class="alert alert-danger" role="alert">
                {{ error_message }}
            </div>
        {% elif special_message %}
            <div class="alert alert-info" role="alert">
                {{ special_message }}
            </div>
        {% endif %}
    {% endif %}

    {% if show_progress %}
        <!-- Progress bar mode -->
        <div class="progress-container mb-2">
            <div class="d-flex justify-content-between mb-1">
                <span class="text-muted">
                    {% if progress_text %}
                        {{ progress_text }}
                    {% else %}
                        Processing {{ button_text }}...
                    {% endif %}
                </span>
                <span class="text-muted">
                    {% if total_items > 0 %}
                        {{ processed_items|default:0 }}/{{ total_items }} ({{ progress_percentage|default:0 }}%)
                    {% else %}
                        Initializing...
                    {% endif %}
                </span>
            </div>
            <div class="progress" style="height: 25px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                     role="progressbar" 
                     style="width: {{ progress_percentage|default:0 }}%"
                     aria-valuenow="{{ progress_percentage|default:0 }}" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                    {{ progress_percentage|default:0 }}%
                </div>
            </div>
            {% if progress_url %}
                <!-- Poll for updates every 500ms -->
                <div hx-get="{{ progress_url }}"
                     hx-trigger="load, every 500ms"
                     hx-target="#{{ container_id }}"
                     hx-swap="outerHTML"></div>
            {% endif %}
        </div>
    {% else %}
        <!-- Button mode -->
        <button hx-post="{{ hx_url }}"
                hx-target="#{{ container_id }}"
                hx-swap="outerHTML"
                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                class="btn {{ button_class|default:'btn-primary' }} w-100">
            <i class="{{ icon_class }} me-1"></i>
            {{ button_text }}
            {% if last_run %}
                - {{ last_run_text }} {{ last_run|date:"d/m/Y H:i:s" }}
            {% else %}
                - {{ never_run_text }}
            {% endif %}
        </button>
    {% endif %}
</div>