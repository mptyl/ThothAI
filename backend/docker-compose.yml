# Copyright (c) 2025 Marco Pancotti
# This file is part of Thoth and is released under the Apache License 2.0.
# See the LICENSE.md file in the project root for full license information.

# UNIFIED Docker Compose - Works on macOS, Linux, and Windows
# Requires Docker Desktop with BuildKit enabled

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      # BuildKit cache configuration for all platforms
      args:
        DOCKER_BUILDKIT: 1
        BUILDKIT_INLINE_CACHE: 1
    image: thoth-be:latest
    container_name: thoth-be
    restart: always
    volumes:
      - ./setup_csv:/app/setup_csv
      - static-data:/vol/static
      - ./exports:/app/exports
      - thoth-shared-data:/app/data
      - ./logs:/app/logs
    environment:
      - DEBUG=False
      - HOST_IP=host.docker.internal
      - DOCKER_ENV=development
    env_file:
      - _env
    networks:
      - thothnet
    extra_hosts:
      # Works on all platforms - Docker Desktop handles this correctly
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/admin/login/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s
    depends_on:
      - qdrant

  qdrant:
    image: qdrant/qdrant:latest
    container_name: thoth-qdrant
    restart: always
    ports:
      - "6333:6333"
    networks:
      - thothnet
    volumes:
      - ./qdrant_storage:/qdrant/storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/"]
      interval: 30s
      timeout: 10s
      retries: 3

  proxy:
    build:
      context: ./proxy
      dockerfile: Dockerfile
    image: thoth-be-proxy:latest
    container_name: thoth-be-proxy
    restart: always
    ports:
      - "8040:80"
    volumes:
      - static-data:/vol/static
      - ./exports:/vol/exports
    environment:
      - APP_HOST=app
      - APP_PORT=8000
      - DEBUG=False
    depends_on:
      app:
        condition: service_healthy
    networks:
      - thothnet

volumes:
  static-data:
    driver: local
  thoth-shared-data:
    external: true
    name: thoth-shared-data

networks:
  thothnet:
    external: true
    name: thothnet