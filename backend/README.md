# Thoth - ThothAI Backend Application

Thoth is the backend component of ThothAI, an application that enables querying relational databases using natural language. 

![docs/assets/home_Thoth_nocomments.png](docs/assets/home_Thoth_nocomments.png)

ThothAI relies on a Django backend and a frontend composed of a set of AI Agents.

> Note on repository layout and Docker orchestration
>
> The canonical Docker orchestration lives at the project root (`/docker-compose.yml`), and the canonical Dockerfiles live under the root `docker/` directory (for backend, frontend, proxy, and sql-generator). Backend-local Docker/compose files that previously lived under `backend/` have been moved to `docs/legacy/backend/` to avoid duplication. Please use the root-level workflow for building and running the full stack.

Overall, ThothAI produces:

- **SQL Queries** generated by AI, which, if correct, are automatically executed.
- **Results** of the executed SQL queries, viewable, sortable, filterable and downloadable in CSV format.
- **Explanations** in non-technical language of the generated SQL (optional).

The frontend component is available at [https://github.com/mptyl/ThothUI.git](https://github.com/mptyl/ThothUI.git) - for UNI at [https://gitlab.uni.com/tylconsulting/thothui.git] (https://gitlab.uni.com/tylconsulting/thothui.git)

## 1. Preliminary Activities
ThothAI is a fairly complex and articulated application. It requires some setup effort, which we have tried to mitigate through extensive use of default values.

### 1.1 Prerequisites
- Docker and Docker Compose
- Git

To simplify and speed up the installation, the standard procedure to follow is based on Docker. Therefore, if you wish to follow the standard instructions, ensure that Docker is installed and that you can successfully execute the `docker compose` command (or `docker-compose` on older versions).

Git is required to clone the application and, if desired, to keep the software updated with `git pull` commands whenever patches or enhancements are released.

The application source code, released under the Apache 2.0 license, is available on GitHub at the following addresses: [https://github.com/mptyl/Thoth.git](https://github.com/mptyl/Thoth.git) and [https://github.com/mptyl/ThothUI.git](https://github.com/mptyl/ThothUI.git).

UNI can find it at the private address [https://gitlab.uni.com/tylconsulting/thoth.git](https://gitlab.uni.com/tylconsulting/thoth.git) and [https://gitlab.uni.com/tylconsulting/thothui.git] (https://gitlab.uni.com/tylconsulting/thothui.git)

**Note**:  
The application can also be compiled and run locally in a typical Python virtual environment (e.g., `venv` or `conda`). 
We do not recommend this solution unless you want to study or customize the code, or if you wish to contribute to its development. 
For standard usage, we strongly recommend using the Docker-based installation as it provides a more reliable and consistent environment with all dependencies properly configured.

## 2. System Architecture

The backend application consists of fivthreee services, each available as a Docker container. The `docker-compose.yml` file defines the configuration of these Docker containers.

The standard configuration assigns the following names to the services within the Docker environment:

### 2.1 thoth-be (Django Backend)
Manages the system's configuration and metadata, which include:
- SQL databases to be queried;
- Vector databases collections (in a 1:1 relationship with SQL databases) containing metadata of the associated relational databases, particularly evidence, question/SQL pairs usable as few-shots, and descriptions of tables and columns;
- LLM models usable by ThothAI (OpenAI, Mistral, Anthropic, etc.). Only models capable of interacting with external tools can be used. Most recently released models have this capability;
- Agents (PydanticAI based) used in the SQL generation workflow, each associated with an LLM. Refer to the PydanticAI documentation ([https://ai.pydantic.dev/](https://ai.pydantic.dev/)) for details on the characteristics of their Agents;
- Authorized users and their association with one or more Groups to define access permissions and frontend activity defaults;
- Workspaces, which link a user to a SQL-vector database pair and the agents to be used in the workflow.


### 2.2 thoth-be-proxy (Nginx)
A proxy for using the Django application in production mode. It handles static files and allows browser access to `thoth-be` at [http://localhost:8040](http://localhost:8040). The port can be changed in the `docker-compose.yml` file.

### 2.4 thoth-qdrant (Vector Database)
Stores metadata of the database that the AI needs to query:
- Evidence to be used in the SQL generation process to 'explain' specific terms to the AI;
- Predefined and verified question-to-SQL associations, often named "Gold SQL";
- Descriptions of tables and fields, extracted from the database schema and enhanced with AI-generated comments;
- Generic semantic documentation providing high-level guidance on the database and its content. The database scope and query language are two of the most important elements used during the SQL generation process

## 3. Installation

### 3.1 Initial Setup

Before starting the installation, you need to set up the project structure:

1. **Create a root directory for the project** with your preferred name. For example:
   ```bash
   mkdir ThothAI
   cd ThothAI
   ```

2. **Clone the repositories** into this root directory:
   
   First, clone the backend repository (thoth):
   ```bash
   git clone https://github.com/mptyl/thoth.git
   ```
   
   Then, clone the frontend repository (thothui):
   ```bash
   git clone https://github.com/mptyl/thothui.git
   ```
   
   **Note for UNI users:** If you're using UNI's internal GitLab, use these commands instead:
   ```bash
   git clone https://gitlab.uni.com/tylconsulting/thoth.git
   git clone https://gitlab.uni.com/tylconsulting/thothui.git
   ```

3. **Enter the backend directory** to proceed with installation:
   ```bash
   cd thoth
   ```

### 3.2 Quick Installation

Once you're in the `thoth` directory, run the quick installation:

**For Windows:**

**Linux/macOS:**
```bash
./install.sh
```

**Windows:**
```cmd
install.bat
```

These scripts will automatically launch the interactive installer that will guide you through:
- Database selection (PostgreSQL, MySQL, SQLite, etc.)
- Vector database configuration (Qdrant, Milvus, Chroma, PGVector)
- Dependency installation and Docker container setup

### 3.2 Docker Setup (root-level workflow)

The project uses a unified, root-level workflow for Docker. Please follow the root `README.md` and scripts:

- From the project root: `./install.sh` (recommended, interactive installer)
- Bring up the full stack from the project root: `docker compose up --build`

Notes:

- Per-service Dockerfiles are under `docker/` (e.g., `docker/backend.Dockerfile`).
- Proxy build uses `docker/proxy.Dockerfile` with build context `backend/proxy/` for Nginx templates and params.
- Legacy backend-local Docker artifacts (old `Dockerfile`, `docker-compose.yml`, setup scripts) have been moved to `docs/legacy/backend/` and are no longer used by the default flow.

### 3.3 Complete Documentation

For complete installation instructions, quick start guide, and comprehensive usage documentation, please visit our official documentation at: **[https://mptyl.github.io/ThothDocs/](https://mptyl.github.io/ThothDocs/)**

The documentation includes:
- **Step-by-step installation guide** with detailed setup procedures
- **Quick start tutorial** to get you up and running immediately
- **Complete user manual** covering all ThothAI features and capabilities
- **Configuration examples** and best practices
- **Troubleshooting guide** for common issues

This README provides a basic overview, but the full documentation contains all the detailed information needed to successfully install, configure, and use ThothAI in production environments.

## 4. Development Setup

For local development without Docker:

```bash
# Install uv package manager
curl -LsSf https://astral.sh/uv/install.sh | sh

# Install base dependencies (PostgreSQL + SQLite included by default)
uv sync

# Optional: Install additional database drivers
# For MariaDB support:
uv sync --extra mariadb

# For SQL Server support:
uv sync --extra sqlserver

# For both MariaDB and SQL Server:
uv sync --extra all-databases

# Install development tools (testing, linting, etc.)
uv sync --extra dev

# Copy environment template
cp _env.template _env
# Edit _env file with your configuration

# Run migrations
uv run python manage.py migrate

# Create superuser
uv run python manage.py createsuperuser

# Start development server
uv run python manage.py runserver
```

### Database Support

ThothAI supports multiple databases through a modular architecture:

- **Default Installation**: PostgreSQL and SQLite (no additional dependencies)
- **Optional Extras**:
  - `mariadb`: Adds MariaDB driver support
  - `sqlserver`: Adds SQL Server driver support  
  - `all-databases`: Installs all optional database drivers

The installer automatically detects and configures the appropriate database drivers based on your selections.

## 5. Testing

```bash
# Run quick tests
./scripts/run-tests-local.sh quick

# Run full test suite
./scripts/run-tests-local.sh full

# Run specific test categories
./scripts/run-tests-local.sh views     # View tests only
./scripts/run-tests-local.sh security  # Security tests only
```

## 6. Useful Links
- **Backend Home Page**: [http://localhost:8040](http://localhost:8040)
- **Admin Panel**: [http://localhost:8040/admin](http://localhost:8040/admin)
- **Frontend Page**: [http://localhost:8501](http://localhost:8501)
- **Qdrant Dashboard**: [http://localhost:6333/dashboard](http://localhost:6333/dashboard)
- **Database from External**: `localhost:5443`

## 7. Contributing

This project uses modern Python tooling:
- **Package Manager**: [uv](https://docs.astral.sh/uv/) for fast dependency management
- **Testing**: pytest with coverage reporting
- **Code Quality**: ruff for linting and formatting
- **Framework**: Django 5.2 with Django REST Framework
- **AI Integration**: PydanticAI for AI agents

Please see `CLAUDE.md` for guidance when working with this codebase using Claude Code.

## 8. License

This project is released under the Apache License 2.0. See `LICENSE.md` for details.