# Copyright (c) 2025 Marco Pancotti
# This file is part of ThothAI and is released under the Apache License 2.0.
# See the LICENSE.md file in the project root for full license information.

# ===== UNIVERSAL ARCHITECTURE =====
# Optimized for multi-architecture support following thoth_be patterns

services:
  thoth-ui:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
        NEXT_PUBLIC_DJANGO_SERVER: http://localhost:8040
        NEXT_PUBLIC_SQL_GENERATOR_URL: http://localhost:8005
      x-bake:
        cache-from:
          - type=inline
        cache-to:
          - type=inline
    container_name: thoth-ui
    restart: always
    ports:
      - "3001:3000"
    volumes:
      - ./public:/app/public:ro  # Static assets
      - thoth-ui-cache:/app/.next/cache  # Build cache
      - ./logs:/app/logs  # Application logs
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_DJANGO_SERVER=http://localhost:8040
      - DJANGO_SERVER=http://thoth-be-proxy:80
      - DJANGO_API_KEY=3LHoZzYlGGsvdamksrcZYlah3H5IArxYnLkrSTBB9pg
      - SQL_GENERATOR_URL=http://thoth-sql-generator:8001
      - NEXT_PUBLIC_SQL_GENERATOR_URL=http://localhost:8005
      - NEXTAUTH_URL=http://localhost:3001
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-thoth-ui-secret-key}
      - DOCKER_CONTAINER=true  # Used by all services to detect Docker environment
      - HOST_IP=host.docker.internal
    env_file:
      - .env.docker
    depends_on:
      - sql-generator
    networks:
      - thothnet
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "host:host-gateway"

  sql-generator:
    build:
      context: ./sql_generator
      dockerfile: Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
      x-bake:
        cache-from:
          - type=inline
        cache-to:
          - type=inline
    container_name: thoth-sql-generator
    restart: always
    ports:
      - "8005:8001"
    volumes:
      - thoth-shared-data:/app/data  # Shared data with backend (contains LSH files)
      - ./sql_generator/logs:/app/logs  # Application logs
    environment:
      - DOCKER_CONTAINER=true  # Used by config_manager and logging to detect Docker environment
      - HOST_IP=host.docker.internal
    env_file:
      - .env.docker
    networks:
      - thothnet
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "host:host-gateway"

volumes:
  thoth-ui-cache:
    name: thoth-ui-cache
  thoth-shared-data:
    external: true

networks:
  thothnet:
    external: true