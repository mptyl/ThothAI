# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Project Overview

ThothAI is an AI-powered text-to-SQL platform that converts natural language questions into SQL queries using a multi-agent architecture. The system uses PydanticAI agents, vector search, and multiple LLM providers to generate, validate, and execute SQL queries against various database types.

## Common Development Commands

### Quick Start (Docker - Recommended)
```bash
# Interactive installer - handles all setup
./install.sh                    # Linux/macOS
install.ps1                     # Windows PowerShell

# Copy configuration template and edit
cp config.yml config.yml.local
# Edit config.yml.local with your API keys and settings

# Start all services
docker compose up -d

# Access applications
# Frontend: http://localhost:3040
# Backend Admin: http://localhost:8040/admin  
# API: http://localhost:8040/api
```

### Local Development Setup
```bash
# Start all services locally
./start-all.sh

# Access services
# Frontend: http://localhost:3200
# Backend: http://localhost:8200
# SQL Generator: http://localhost:8180
# Qdrant: http://localhost:6334
```

### Backend Development (Django)
```bash
cd backend

# Install dependencies (uses uv)
uv sync

# Database operations
uv run python manage.py migrate
uv run python manage.py createsuperuser
uv run python manage.py runserver 8200

# Testing
uv run pytest tests/                    # All tests
uv run pytest tests/ -m unit            # Unit tests only
uv run pytest tests/ -m integration     # Integration tests
./scripts/run-tests-local.sh quick      # Quick smoke tests
./scripts/run-tests-local.sh full       # Full test suite with coverage

# Code quality
uv run ruff check .
uv run ruff format .
```

### Frontend Development (Next.js)
```bash
cd frontend

# Install and run
npm install
npm run dev                    # Development server on port 3200
npm run build                  # Production build
npm test                       # Run tests
npm run lint                   # Lint code
```

### SQL Generator Service (FastAPI)
```bash
cd frontend/sql_generator

# Install dependencies
uv sync

# Run service
uv run python main.py          # Starts on port 8180

# Test the API
curl -X POST "http://localhost:8180/generate-sql" \
  -H "Content-Type: application/json" \
  -d '{
    "workspace_id": 4,
    "question": "How many schools are exclusively virtual?",
    "username": "demo",
    "functionality_level": "BASIC",
    "flags": {
      "use_schema": true,
      "use_examples": true,
      "use_lsh": true,
      "use_vector": true
    }
  }'
```

### Docker Operations
```bash
# Build and start all services
docker compose up --build

# Stop all services  
docker compose down

# View logs
docker compose logs [service-name]

# Clean rebuild
./install.sh --clean-cache

# Remove all ThothAI resources
./install.sh --prune-all
```

## Architecture Overview

### Service Architecture
ThothAI uses a microservices architecture with the following components:

**Core Services:**
- **Backend (Django)**: REST API, admin interface, workflow orchestration
- **Frontend (Next.js)**: Web interface for user interactions
- **SQL Generator (FastAPI)**: PydanticAI-powered SQL generation service
- **Qdrant**: Vector database for semantic search and embeddings
- **Nginx Proxy**: Reverse proxy and load balancer (Docker only)

**Service Communication:**
- Docker: Services communicate via internal Docker network
- Local: Direct HTTP calls between services on different ports
- Authentication: Token-based auth using Django REST Framework

### Multi-Agent SQL Generation Workflow

ThothAI uses a sophisticated multi-agent approach powered by PydanticAI:

1. **Question Analysis**: Natural language processing to understand user intent
2. **Schema Retrieval**: LSH-based schema matching + vector similarity search via Qdrant
3. **SQL Generation**: Multiple candidate queries generated by PydanticAI agents
4. **Validation & Selection**: Evaluator agent validates syntax and selects optimal query
5. **Execution & Results**: Query execution with pagination and explanation

**Key Agents** (located in `frontend/sql_generator/agents/`):
- `test_generator_with_evaluator`: Main SQL generation agent
- `sql_selector_agent`: Selects best SQL from multiple candidates  
- `test_reducer_agent`: Optimizes and reduces test cases

### Database Architecture

**SQL Databases**: 
- Managed through `thoth-dbmanager` library
- Supports: PostgreSQL, MySQL, SQLite, MariaDB, SQL Server
- Connection pooling via SQLAlchemy

**Vector Database (Qdrant)**:
- Stores embeddings for schema elements, examples, and documentation
- Automatic collection creation matching SQL database names
- Supports multiple embedding providers (OpenAI, Cohere, Mistral)

### Configuration Management

ThothAI uses a multi-level configuration system:

**Docker Deployment**: 
```
config.yml.local → installer.py → .env.docker → docker-compose.yml
```

**Local Development**:
```
.env.local → environment variables → service processes
```

**Key Configuration Files**:
- `config.yml.local`: Master config for Docker (API keys, ports, database drivers)
- `.env.local`: Local development environment variables
- `.env.docker`: Auto-generated Docker environment file
- `pyproject.toml`: Python dependencies and build configuration

## Important Development Notes

### Python Package Management
- Uses `uv` for consistent Python version management (3.13.5)
- Virtual environments created with `uv venv`
- Dependencies managed via `pyproject.toml` files

### AI Provider Integration
The system supports multiple AI providers:
- **LLM Providers**: OpenAI, Anthropic, Gemini, Mistral, DeepSeek, OpenRouter, Ollama, LM Studio
- **Embedding Providers**: OpenAI, Cohere, Mistral
- Configuration via API keys in config files

### Testing Strategy
- **Backend**: pytest with Django integration, isolated test containers
- **Test Types**: Unit tests, integration tests, security tests, view tests
- **Coverage**: HTML reports generated in `backend/htmlcov/`
- **CI/CD**: GitHub Actions workflow for automated testing

### Security & Authentication
- Token-based API authentication required for all endpoints except `/api/login/`
- API keys stored in Docker secrets volume (production) or environment files (development)
- CORS configuration for frontend-backend communication

### Development Workflow Best Practices
1. Always test locally before Docker deployment
2. Use `uv sync` for Python dependencies, `npm install` for Node.js
3. Run migrations with `uv run python manage.py migrate` 
4. Test with pytest/npm test before commits
5. Use ruff for Python linting, eslint for JavaScript
6. Include Apache 2.0 license header in new code files

### Port Configuration
**Docker Ports**: Frontend (3040), SQL Generator (8020), Proxy (8040), Qdrant (6333)
**Local Ports**: Frontend (3200), Backend (8200), SQL Generator (8180), Qdrant (6334)

### File Structure Context
```
ThothAI/
├── backend/                  # Django backend
│   ├── thoth_core/          # Core models, admin, database management
│   ├── thoth_ai_backend/    # AI workflow implementation, views, preprocessing
│   └── Thoth/               # Django project settings and configuration
├── frontend/                 # Next.js frontend
│   ├── sql_generator/       # FastAPI SQL generation service with PydanticAI agents
│   ├── src/                 # Next.js application source
│   └── components/          # React components
├── docker/                   # Dockerfiles for all services
├── scripts/                  # Utility and deployment scripts
└── data_exchange/           # Runtime data import/export directory
```